# Analisi di Malware - Setup e Metodologie

## Introduzione

L'analisi di malware è una disciplina fondamentale della cybersecurity che richiede precauzioni specifiche e l'uso di strumenti specializzati. Questa guida documenta il processo completo dall'setup dell'ambiente fino all'analisi statica e dinamica di un campione di malware.

## Regole Fondamentali per l'Analisi di Malware

Prima di iniziare qualsiasi analisi, è essenziale seguire queste regole di sicurezza:

1. **Mai connettere la VM al network reale**
2. **Isolamento totale** (disabilitare shared clipboard e drag & drop)
3. **Utilizzare snapshot frequentemente**
4. **Lavorare SOLO su macchine virtuali**

> ⚠️ **ATTENZIONE**: Il mancato rispetto di queste regole può compromettere la sicurezza dell'intero sistema host.

## Strumenti Necessari

### Strumenti per Analisi Statica
- **PEStudio**: Analisi statica dei file PE
- **HxD**: Editor esadecimale
- **Ghidra**: Reverse engineering e disassemblaggio

### Strumenti per Analisi Dinamica
- **ProcMon**: Monitoraggio processi/file/registry
- **x64dbg**: Debugger avanzato
- **Wireshark**: Analisi traffico di rete
- **Autoruns**: Verifica persistenza
- **Regshot**: Confronto modifiche al registry

### Ambiente di Analisi
- **VM Windows**: Per l'esecuzione del malware
- **REMnux**: Distribuzione Linux specializzata per malware analysis

## Acquisizione del Campione di Malware

### Download del Campione

1. Accedere alla VM REMnux
2. Navigare nella directory dei campioni:

```bash
cd ~/malware-samples
mkdir sample1 && cd sample1
```

3. Scaricare il campione da MalwareBazaar:

```bash
wget --content-disposition https://mb-api.abuse.ch/download/<SAMPLE_HASH>
```

> **Nota**: È necessario ottenere una API key registrandosi sul sito di MalwareBazaar.

4. Estrarre il file con la password standard:

```bash
unzip -P infected <nome_file>.zip
```

## Analisi Statica

### Identificazione del Tipo di File

Il primo passo nell'analisi statica è identificare il tipo di file:

```bash
file <nome_file>.exe
```

**Output di esempio:**
```
a19b171658151c4a4af32dd17474a8184cc37a0d99138ae540177e15cebd9093.exe: PE32 executable (GUI) Intel 80386, for MS Windows, Nullsoft Installer self-extracting archive
```

**Informazioni ottenute:**
- Eseguibile Windows a 32 bit
- Interfaccia grafica (GUI)
- Architettura Intel 80386
- Installer Nullsoft

### Estrazione delle Stringhe

L'analisi delle stringhe rivela informazioni cruciali sul comportamento del malware:

```bash
strings sample.exe | less
```

#### Manifest Windows Identificato

Il file contiene un manifesto XML che definisce:

```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<assembly xmlns="urn:schemas-microsoft-com:asm.v1" manifestVersion="1.0">
    <assemblyIdentity version="1.0.0.0" processorArchitecture="*" 
                     name="Nullsoft.NSIS.exehead" type="win32"/>
    <description>Nullsoft Install System v3.0a2</description>
    <!-- ... altre definizioni ... -->
</assembly>
```

**Elementi chiave del manifest:**
- **Identità**: Nullsoft.NSIS.exehead
- **Versione**: Nullsoft Install System v3.0a2
- **Livello di esecuzione**: `asInvoker` (privilegi utente corrente)
- **Compatibilità**: Multiple versioni Windows

#### API Windows Identificate

Il malware utilizza numerose API Windows categorizzate per DLL:

**KERNEL32.dll:**
- `CreateFileA`, `WriteFile`, `DeleteFileA` (gestione file)
- `CreateProcessA` (creazione processi)
- `LoadLibraryA`, `GetProcAddress` (caricamento librerie)

**ADVAPI32.dll:**
- `AdjustTokenPrivileges` (escalation privilegi)
- `OpenProcessToken` (manipolazione token)
- `RegOpenKeyExA`, `RegSetValueExA` (manipolazione registry)

**USER32.dll:**
- `CreateWindowExA`, `SendMessageA` (interfaccia grafica)
- `MessageBoxIndirectA` (messaggi utente)

**SHELL32.dll:**
- `ShellExecuteA` (esecuzione comandi)
- `SHFileOperationA` (operazioni file)

#### Messaggi di Errore Standard NSIS

```
Installer integrity check has failed. Common causes include
incomplete download and damaged media. Contact the
installer's author to obtain a new copy.

Error writing temporary file. Make sure your temp folder is valid.
Error launching installer
```

## Analisi Dinamica

### Setup dell'Ambiente

1. **Creazione snapshot** della VM Windows pulita
2. **Esecuzione prima scansione** con Regshot
3. **Installazione ed esecuzione** del malware
4. **Esecuzione seconda scansione** con Regshot

### Comportamento Osservato

#### Attività Iniziale
- **Apertura terminale** improvvisa
- **Messaggi di errore** multiple
- **Modifiche non immediatamente visibili**

#### Analisi con Regshot

**File eseguiti:**
```
C:\Users\aless\virus.exe
```

**File Prefetch creati:**
```
C:\WINDOWS\Prefetch\VIRUS.EXE-BA3AFA33.pf
```

**Entry BAM (Background Activity Moderator):**
- Multiple entry che tracciano l'esecuzione di virus.exe

**Chiavi di registro sospette aggiunte:**
```
HKU\...\iagttagelsesevnens\unundulatory
HKU\...\induism\awlworts\kamufleringens
```

#### Persistenza Identificata

- **Backdoor persistenti** create nel sistema
- **Servizio falso** denominato "GoogleUpdater"
- **Auto-occultamento** del processo (sparizione dalle proprietà)

> ⚠️ **AVVISO**: Il malware ha dimostrato capacità di evasione e nascondimento, confermando la necessità di isolamento completo.

## Reverse Engineering con Ghidra

### Analisi del Disassemblato

#### Struttura del Malware

**Wrapper NSIS:**
- Utilizza NSIS come installer/dropper
- Inizializzazione COM (`OleInitialize`)
- Gestione shell (`SHGetFileInfoA`, `GetTempPathA`)

#### Comportamenti Malevoli Identificati

**Privilege Escalation:**
```c
AdjustTokenPrivileges()
OpenProcessToken()
SeShutdownPrivilege
```

**Manipolazione Sistema:**
```c
ExitWindowsEx() // Riavvio/spegnimento sistema
GetWindowsDirectoryA(&DAT_0042a400,0x3fb);
lstrcatA(&DAT_0042a400,s_\\Temp\\);
```

**Operazioni File:**
- `CopyFileA` verso directory temporanee
- `DeleteFileA` per rimozione tracce
- `CreateDirectoryA` per setup persistenza

#### Indicatori di Offuscamento

- **Variabili anonime**: `DAT_0042a400`, `local_17c`
- **Assenza simboli** nel binario originale
- **Controllo flusso complesso** con goto e switch
- **Code dinamico** (`pcVar8`, `pcVar9`, `pcVar10`)

### Tecniche Anti-Debugging

Il malware implementa diverse tecniche per evitare l'analisi:

1. **Controllo argomenti** riga di comando (`/S`, `/D`)
2. **Matching stringhe** byte-per-byte
3. **Salti condizionali** complessi
4. **File temporanei** con nomi casuali (`~nsu.tmp`)

## Conclusioni dell'Analisi

### Classificazione del Malware

**Tipo**: Dropper/Installer malevolo
**Famiglia**: Probabile RAT (Remote Access Trojan)
**Packer**: NSIS (Nullsoft Scriptable Install System)

### Capacità Identificate

1. **Privilege Escalation**: Tentativo di ottenere privilegi amministrativi
2. **Persistenza**: Creazione servizi falsi e chiavi registry
3. **Evasion**: Tecniche anti-debugging e auto-occultamento  
4. **System Control**: Capacità di riavvio/spegnimento sistema
5. **File Operations**: Drop e manipolazione file in directory temporanee

### Indicatori di Compromissione (IoCs)

**File:**
- `virus.exe`
- `C:\WINDOWS\Prefetch\VIRUS.EXE-BA3AFA33.pf`
- File temporanei in `%TEMP%` con pattern `~nsu.tmp`

**Registry:**
- Chiavi con nomi offuscati sotto `HKU`
- Possibili entry di persistenza

**Servizi:**
- "GoogleUpdater" (falso servizio Google)

**Comportamenti:**
- Entry BAM per tracking esecuzione
- Modifiche privilegi di sistema
- Tentativi di elevazione privilegi

## Raccomandazioni

### Prevenzione
1. **Educazione utenti** sui rischi di installer non verificati
2. **Implementazione sandboxing** per file sconosciuti
3. **Monitoraggio registry** per chiavi sospette
4. **Controllo servizi** per entry non autorizzate

### Detection
1. **Monitoraggio API** calls sospette (AdjustTokenPrivileges)
2. **Analisi behavior** per pattern NSIS malevoli
3. **Scanning prefetch** files per eseguibili sconosciuti
4. **Registry monitoring** per chiavi offuscate

### Response
1. **Isolamento immediato** sistema compromesso
2. **Ripristino da backup** verificato pulito
3. **Scansione completa** rete per propagazione
4. **Update signatures** antimalware

---

## Posizionamento nel Repository

**Cartella suggerita**: `/MalwareAnalysis/`

**Motivazione**: Questo documento copre specificamente metodologie e tecniche di analisi malware, dall'setup dell'ambiente all'analisi statica e dinamica. Rappresenta una guida completa per analisti di sicurezza e necessita di una sezione dedicata per la sua specificità tecnica e i rischi associati alla manipolazione di codice malevolo.